# 云函数部署和调用指南

## 1. 部署云函数

### 步骤
1. **打开微信开发者工具**
   - 启动微信开发者工具
   - 导入项目：选择项目根目录 `/Users/joshua/Documents/GitHub/Chinesetraditional-miniprogram`
   - 登录微信开发者工具

2. **部署云函数**
   - 在左侧导航栏中选择「云开发」
   - 切换到「云函数」标签页
   - 右键点击 `import_to_cloud` 云函数目录
   - 选择「上传并部署：云端安装依赖」
   - 等待部署完成（可能需要几分钟）

3. **验证部署结果**
   - 部署完成后，在云函数列表中可以看到 `import_to_cloud` 函数
   - 状态显示为「已部署」

## 2. 调用检查功能

### 步骤
1. **打开云函数列表**
   - 在云开发控制台中，切换到「云函数」标签页
   - 找到 `import_to_cloud` 函数

2. **调用函数**
   - 点击函数名称进入函数详情页
   - 切换到「测试」标签页
   - 填写测试参数：
     ```json
     {
       "action": "check"
     }
     ```
   - 点击「运行测试」按钮

3. **查看结果**
   - 等待测试完成
   - 在「测试结果」中查看返回数据
   - 记录当前云数据库中的数据条数（例如：`count: 463`）

## 3. 调用导入功能

### 步骤
1. **调用导入函数**
   - 保持在函数详情页的「测试」标签页
   - 清空测试参数（或使用默认空对象 `{}`）
   - 点击「运行测试」按钮

2. **查看导入结果**
   - 等待测试完成（可能需要1-2分钟）
   - 在「测试结果」中查看返回数据
   - 检查导入结果：
     - `success: true` 表示导入成功
     - `imported` 字段表示成功导入的数据条数（应为91）
     - `failed` 字段表示失败的数据条数（应为0）

## 4. 验证导入结果

### 步骤
1. **再次调用检查功能**
   - 重复「调用检查功能」的步骤
   - 填写测试参数：
     ```json
     {
       "action": "check"
     }
     ```
   - 点击「运行测试」按钮

2. **验证数据量**
   - 查看返回的 `count` 字段
   - 新数据条数 = 原数据条数 + 91（例如：463 + 91 = 554）
   - 如果数据条数正确，说明导入成功

## 5. 常见问题及解决方案

### 问题1：部署失败
- **原因**：依赖安装失败、网络问题、权限问题
- **解决方案**：
  - 检查网络连接
  - 确保微信开发者工具已登录
  - 检查 `package.json` 中的依赖配置

### 问题2：导入失败
- **原因**：数据格式错误、字段缺失、权限问题
- **解决方案**：
  - 检查 `export_data.json` 文件格式
  - 确保所有必需字段都存在
  - 检查云函数的权限配置

### 问题3：数据重复
- **原因**：已存在相同id的记录
- **解决方案**：
  - 云函数会自动更新已存在的记录
  - 可以通过查看云函数日志确认处理情况

## 6. 查看云函数日志

1. 在云函数详情页中，切换到「日志」标签页
2. 可以查看所有函数调用的日志记录
3. 可以按时间范围、请求ID等筛选日志
4. 日志中包含详细的执行信息，便于排查问题

## 7. 数据验证

### 验证数据完整性
1. 在云开发控制台中，切换到「数据库」标签页
2. 选择 `daily_characters` 集合
3. 查看数据列表，确认新数据已添加
4. 可以通过查询条件 `{ id: { $gte: 464 } }` 查看新增的数据

### 验证数据格式
1. 随机选择几条新增数据
2. 检查字段是否完整
3. 检查数据类型是否正确
4. 检查内容是否符合预期

## 8. 清理临时文件

部署完成后，可以清理临时生成的测试脚本：

```bash
# 删除临时测试脚本
rm /Users/joshua/Documents/GitHub/Chinesetraditional-miniprogram/test_cloud_function.js
rm /Users/joshua/Documents/GitHub/Chinesetraditional-miniprogram/subgames/daily-character/transform_data.js
```

---

**注意事项**：
- 确保云开发环境已开通
- 确保云函数有足够的权限访问数据库
- 导入过程中不要关闭微信开发者工具
- 如遇到问题，请查看云函数日志进行排查