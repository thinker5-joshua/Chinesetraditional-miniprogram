<view class="container">
  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <text>正在生成测试题...</text>
  </view>

  <!-- 测试进行中 -->
  <view class="test-container" wx:elif="{{testStatus === 'testing'}}">
    <!-- 进度指示器 -->
    <view class="progress-indicator">
      <text class="progress-text">第 {{currentQuestionIndex + 1}} / {{testQuestions.length}} 题</text>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{(currentQuestionIndex + 1) / testQuestions.length * 100}}%"></view>
      </view>
    </view>

    <!-- 当前题目 -->
    <view class="question-section">
      <text class="question-character">{{testQuestions[currentQuestionIndex].character}}</text>
      <view class="related-phrases">
        <text class="phrases-label">相关词组：</text>
        <view class="phrases-content">
          <view wx:if="{{testQuestions[currentQuestionIndex].relatedPhrases && testQuestions[currentQuestionIndex].relatedPhrases.length > 0}}" class="phrases-list">
            <text class="phrase-item" wx:for="{{testQuestions[currentQuestionIndex].relatedPhrases}}" wx:key="index">{{item}}{{index < testQuestions[currentQuestionIndex].relatedPhrases.length - 1 ? '、' : ''}}</text>
          </view>
          <text wx:else class="phrases-text">暂无</text>
        </view>
      </view>
      <text class="question-prompt">请选择正确的读音</text>
    </view>

    <!-- 选项列表 -->
    <view class="options-list">
      <block wx:for="{{testQuestions[currentQuestionIndex].options}}" wx:key="index">
        <view class="option-item" 
              bindtap="handleAnswerSelect"
              data-answer="{{item.value}}"
              class="option-{{index}} {{selectedClass(testQuestions[currentQuestionIndex].userAnswer, item.value, testQuestions[currentQuestionIndex].correctAnswer)}}">
          <view class="option-content">
            <view class="option-label">
              <text>{{item.label}}</text>
            </view>
            <text class="option-text">{{item.value}}</text>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- 测试结果 -->
  <view class="result-container" wx:elif="{{testStatus === 'finished'}}">
    <view class="result-header">
      <text class="result-title">测试完成</text>
      <text class="result-grade">{{testResult.grade}}</text>
    </view>

    <view class="result-stats">
      <view class="stat-item">
        <text class="stat-label">正确题数</text>
        <text class="stat-value">{{testResult.correctCount}} / {{testResult.totalCount}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">获得积分</text>
        <text class="stat-value">{{testResult.score}} 分</text>
      </view>
    </view>

    <view class="result-message">
      <text wx:if="{{testResult.correctCount === testResult.totalCount}}">太棒了！你全部答对了！</text>
      <text wx:elif="{{testResult.correctCount >= 4}}">不错！继续保持！</text>
      <text wx:elif="{{testResult.correctCount >= 3}}">合格了！再努力一点可以更棒！</text>
      <text wx:else>别灰心，继续练习吧！</text>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <button class="action-btn restart-btn" bindtap="restartTest">
        重新测试
      </button>
      <button class="action-btn back-btn" bindtap="backToCard">
        返回字卡
      </button>
    </view>

    <!-- 答题回顾 -->
    <view class="review-section">
      <view class="section-title">答题回顾</view>
      <view class="review-item" wx:for="{{testQuestions}}" wx:key="index">
        <view class="review-character">{{item.character}}</view>
        <view class="review-answers">
          <text class="review-correct">正确：{{item.correctAnswer}}</text>
          <text class="review-user" wx:if="{{item.userAnswer === item.correctAnswer}}">✓ 你的答案：{{item.userAnswer}}</text>
          <text class="review-user wrong" wx:else>✗ 你的答案：{{item.userAnswer}}</text>
        </view>
      </view>
    </view>
  </view>
</view>