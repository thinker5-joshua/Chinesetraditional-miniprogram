<view class="container">
  <!-- æ¸¸æˆæ ‡é¢˜å’Œæ§åˆ¶åŒº -->
  <view class="header-section">
    <text class="game-title">å®¶æ—è°±ç³»æ¢ç´¢</text>
    <view class="control-panel">
      <view class="perspective-switch">
        <text class="switch-label">æˆ‘æ˜¯ï¼š</text>
        <button class="switch-btn {{perspective === 'husband' ? 'active' : ''}}" 
                bindtap="switchPerspective" data-perspective="husband">å¤«</button>
        <button class="switch-btn {{perspective === 'wife' ? 'active' : ''}}" 
                bindtap="switchPerspective" data-perspective="wife">å¦»</button>
      </view>
      <view class="zoom-controls">
        <button class="zoom-btn" bindtap="zoomIn">+</button>
        <text class="zoom-level">{{Math.round(scale * 100)}}%</text>
        <button class="zoom-btn" bindtap="zoomOut">-</button>
        <button class="zoom-btn reset-btn" bindtap="resetView">é‡ç½®</button>
      </view>
    </view>
  </view>

  <!-- å®¶æ—æ ‘ç”»å¸ƒ -->
  <view class="tree-canvas-container">
    <scroll-view class="tree-scroll" 
                scroll-x="{{true}}" 
                scroll-y="{{true}}"
                enable-flex="{{true}}"
                style="width: 100%; height: 100%;">
      <view class="tree-canvas" 
            style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; transform: scale({{scale}}) translate({{translateX}}px, {{translateY}}px);"
            bindtouchstart="onCanvasTouchStart"
            bindtouchmove="onCanvasTouchMove"
            bindtouchend="onCanvasTouchEnd">
        
        <!-- è¿æ¥çº¿ -->
        <view class="connections-layer">
          <view wx:for="{{connections}}" wx:key="id" 
                class="connection {{item.type}}"
                style="left: {{item.x1}}px; top: {{item.y1}}px; width: {{item.width}}px; height: {{item.height}}px; transform: rotate({{item.angle}}deg);"></view>
        </view>
        
        <!-- å®¶æ—æˆå‘˜èŠ‚ç‚¹ -->
        <view class="family-members">
          <view wx:for="{{familyMembers}}" wx:key="id" 
                class="family-node {{item.gender}} {{item.selected ? 'selected' : ''}} {{perspective === 'wife' && item.isFromHusbandSide ? 'husband-side' : ''}}"
                style="left: {{item.x}}px; top: {{item.y}}px;"
                bindtap="selectMember" data-member-id="{{item.id}}">
            
            <view class="node-avatar {{item.gender}}">
              <text class="avatar-text">{{item.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}}</text>
            </view>
            
            <view class="node-info">
              <text class="node-name">{{item.displayName || item.name}}</text>
              <text class="node-relation">{{item.relationFromPerspective}}</text>
            </view>
            
            <!-- é…å¶è¿æ¥æŒ‡ç¤ºå™¨ -->
            <view wx:if="{{item.spouseId}}" class="spouse-indicator"></view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å…³ç³»è¯¦æƒ…å¼¹çª— -->
  <view class="relation-modal {{showRelationModal ? 'show' : ''}}" wx:if="{{showRelationModal}}">
    <view class="modal-overlay" bindtap="closeRelationModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å…³ç³»åˆ†æ</text>
        <button class="close-btn" bindtap="closeRelationModal">Ã—</button>
      </view>
      
      <view class="relation-result">
        <view class="selected-members">
          <view class="member-card">
            <view class="member-avatar {{selectedMembers[0].gender}}">
              <text>{{selectedMembers[0].gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}}</text>
            </view>
            <text class="member-name">{{selectedMembers[0].displayName || selectedMembers[0].name}}</text>
          </view>
          
          <view class="relation-arrow">â‡„</view>
          
          <view class="member-card">
            <view class="member-avatar {{selectedMembers[1].gender}}">
              <text>{{selectedMembers[1].gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}}</text>
            </view>
            <text class="member-name">{{selectedMembers[1].displayName || selectedMembers[1].name}}</text>
          </view>
        </view>
        
        <view class="relation-details">
          <view class="relation-item">
            <text class="relation-label">å…³ç³»ç±»å‹ï¼š</text>
            <text class="relation-value">{{relationResult.relationship}}</text>
          </view>
          
          <view class="relation-item">
            <text class="relation-label">{{selectedMembers[1].displayName || selectedMembers[1].name}} åº”è¯¥ç§°å‘¼ {{selectedMembers[0].displayName || selectedMembers[0].name}} ä¸ºï¼š</text>
            <text class="relation-value highlight">{{relationResult.person2ToPerson1}}</text>
          </view>
          
          <view class="relation-item">
            <text class="relation-label">{{selectedMembers[0].displayName || selectedMembers[0].name}} åº”è¯¥ç§°å‘¼ {{selectedMembers[1].displayName || selectedMembers[1].name}} ä¸ºï¼š</text>
            <text class="relation-value highlight">{{relationResult.person1ToPerson2}}</text>
          </view>
        </view>
      </view>
      
      <view class="modal-actions">
        <button class="action-btn secondary" bindtap="closeRelationModal">å…³é—­</button>
        <button class="action-btn primary" bindtap="clearSelection">é‡æ–°é€‰æ‹©</button>
      </view>
    </view>
  </view>

  <!-- ä½¿ç”¨è¯´æ˜ -->
  <view class="help-panel {{showHelp ? 'show' : ''}}" wx:if="{{showHelp}}">
    <view class="help-overlay" bindtap="toggleHelp"></view>
    <view class="help-content">
      <view class="help-header">
        <text class="help-title">ä½¿ç”¨è¯´æ˜</text>
        <button class="close-btn" bindtap="toggleHelp">Ã—</button>
      </view>
      <view class="help-items">
        <view class="help-item">
          <text class="help-icon">ğŸ‘†</text>
          <text class="help-text">ç‚¹å‡»ä¸¤ä¸ªå®¶æ—æˆå‘˜æŸ¥çœ‹å…³ç³»</text>
        </view>
        <view class="help-item">
          <text class="help-icon">ğŸ”</text>
          <text class="help-text">æ”¯æŒç¼©æ”¾å’Œæ‹–æ‹½æŸ¥çœ‹</text>
        </view>
        <view class="help-item">
          <text class="help-icon">ğŸ‘«</text>
          <text class="help-text">åˆ‡æ¢"å¤«/å¦»"è§†è§’æŸ¥çœ‹ä¸åŒç§°å‘¼</text>
        </view>
        <view class="help-item">
          <text class="help-icon">ğŸ”—</text>
          <text class="help-text">çº¿æ¡è¡¨ç¤ºå¤«å¦»å’Œäº²å­å…³ç³»</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å¸®åŠ©æŒ‰é’® -->
  <button class="help-btn" bindtap="toggleHelp">?</button>
</view>