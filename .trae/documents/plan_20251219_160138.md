# 守护神兽全局图像缓存实现计划

## 问题分析

当前守护神兽项目存在以下问题：
1. 图片管理采用集中式配置（imageConfig.js），但缺乏统一的缓存机制
2. 只有poster页面实现了本地缓存，其他页面（首页、抽取页、结果页等）仍直接从云存储加载图片
3. 不同页面的图片加载逻辑不一致，导致代码重复和维护困难
4. 缺乏全局缓存管理，无法统一处理缓存的增删改查

## 缓存架构设计

### 1. 缓存模块设计
- 创建独立的`imageCache.js`模块，封装所有缓存相关逻辑
- 提供统一的图片加载接口，供所有页面调用
- 支持云文件和本地文件的统一处理
- 实现缓存检查、下载、保存、清理的完整流程

### 2. 缓存策略
- **缓存命名**：使用文件ID的哈希值作为本地缓存文件名
- **缓存有效期**：7天过期，定期清理
- **缓存清理**：在应用启动时和页面加载时清理过期缓存
- **缓存路径**：使用微信小程序的`wx.env.USER_DATA_PATH`存储缓存文件

### 3. 核心功能
- `getImage`：统一的图片加载接口，返回缓存路径或下载后的路径
- `preloadImages`：预加载多张图片到缓存
- `clearExpiredCache`：清理过期缓存
- `getCacheInfo`：获取缓存统计信息

## 代码修改方案

### 1. 创建全局缓存模块
- 创建`imageCache.js`文件，封装缓存管理逻辑
- 提供统一的API接口，供所有页面使用
- 确保与poster页面的缓存机制保持一致

### 2. 修改imageConfig.js
- 集成缓存机制，使`getImage`方法返回缓存路径
- 添加`preloadAllImages`方法，预加载所有配置的图片
- 保持原有API兼容性，确保现有代码无需大量修改

### 3. 更新页面代码
- **index.js**：修改图片预加载逻辑，使用缓存模块
- **draw.js**：修改卡牌背面图加载逻辑，使用缓存模块
- **result.js**：修改神兽图片加载逻辑，使用缓存模块
- **knowledge/**：修改详情页图片加载逻辑，使用缓存模块

### 4. 统一缓存管理
- 在app.js中添加全局缓存清理逻辑
- 确保所有页面使用相同的缓存机制
- 提供缓存统计和管理功能

## 实施步骤

1. **创建imageCache.js模块**：
   - 实现缓存工具函数
   - 提供统一的图片加载接口
   - 实现缓存清理功能

2. **修改imageConfig.js**：
   - 集成缓存模块
   - 更新getImage方法，返回缓存路径
   - 添加preloadAllImages方法

3. **更新首页index.js**：
   - 修改preloadAllImages和preloadImage方法
   - 使用缓存模块加载图片

4. **更新抽取页draw.js**：
   - 修改图片加载逻辑，使用缓存模块

5. **更新结果页result.js**：
   - 修改图片加载逻辑，使用缓存模块

6. **更新知识详情页**：
   - 修改图片加载逻辑，使用缓存模块

7. **测试验证**：
   - 测试所有页面的图片加载是否正常
   - 验证缓存机制是否生效
   - 检查缓存清理功能是否正常

## 预期效果

1. **统一缓存机制**：所有页面使用相同的缓存逻辑，提高代码复用性和维护性
2. **减少网络请求**：所有图片只下载一次，后续直接从本地读取
3. **提高加载速度**：本地缓存比网络请求更快，提升用户体验
4. **降低云存储流量**：减少重复下载，降低云存储费用
5. **统一管理**：方便进行缓存统计和管理

## 技术要点

- 使用模块化设计，确保缓存逻辑的可复用性
- 保持原有API兼容性，减少代码修改量
- 使用Promise和async/await优化异步流程
- 实现完整的缓存生命周期管理
- 提供详细的日志记录，方便调试和监控

通过实现全局图像缓存机制，守护神兽项目的所有页面将共享一套缓存逻辑，提高图片加载速度和用户体验，同时降低云存储流量消耗。