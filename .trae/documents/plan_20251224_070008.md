# 云存储图片获取与本地缓存实现方案

## 问题分析
1. **云存储图片路径访问失败**：当前使用的云存储路径在本地调试时无法访问
2. **需要实现缓存机制**：首次读取后缓存到本地，下次直接获取本地缓存文件
3. **需要兼容不同环境**：在本地调试和线上环境都能正常工作

## 解决方案

### 1. 实现云存储图片下载与本地缓存
- **步骤1**：首先检查本地是否有缓存的图片
- **步骤2**：如果有缓存，直接使用本地缓存文件
- **步骤3**：如果没有缓存，使用 `wx.cloud.downloadFile` 从云存储下载图片
- **步骤4**：下载成功后，使用 `wx.setStorage` 将图片缓存到本地
- **步骤5**：使用下载或缓存的图片进行绘制

### 2. 优化图片加载逻辑
- 保持现有的 `onload` 和 `onerror` 事件处理
- 确保即使图片加载失败，也能完成卡片生成和保存
- 添加详细的错误处理和日志

### 3. 具体实现逻辑
```javascript
// 云存储图片路径
const cloudImagePath = 'cloud://cloud1-4g76v9gbd3112c01.636c-cloud1-4g76v9gbd3112c01-1391701420/main/wyhd-minipro.png';
// 本地缓存key
const imageCacheKey = 'wxapp_qrcode_image';

// 检查本地缓存
wx.getStorage({ key: imageCacheKey, success: (res) => {
  // 有缓存，直接使用
  img.src = res.data;
}, fail: () => {
  // 无缓存，从云存储下载
  wx.cloud.downloadFile({
    fileID: cloudImagePath,
    success: (res) => {
      // 下载成功，缓存到本地
      wx.setStorage({ key: imageCacheKey, data: res.tempFilePath });
      img.src = res.tempFilePath;
    },
    fail: () => {
      // 下载失败，触发onerror
      img.onerror();
    }
  });
}});
```

### 4. 考虑使用本地默认图片作为备选
- 如果云存储下载失败，且本地没有缓存，可以使用本地默认图片
- 项目根目录下的 `images/wyhd-share-default.png` 可以作为备选

## 预期效果
1. 首次使用时，从云存储下载图片并缓存到本地
2. 后续使用时，直接从本地缓存获取图片，提高加载速度
3. 即使云存储访问失败，也能使用本地缓存或备选图片
4. 在本地调试和线上环境都能正常工作

## 修改文件
- `/subgames/64Hexagrams/index.js`

## 修改内容
1. 在 `saveHexagramCard` 函数中，实现云存储图片的下载与本地缓存逻辑
2. 替换当前直接设置 `img.src` 的代码，改为先检查缓存，再下载云存储图片
3. 添加必要的错误处理和日志

这个方案将解决小程序码图片加载失败的问题，并实现本地缓存机制，提高存卡片功能的可靠性和性能。