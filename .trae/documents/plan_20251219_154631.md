# 守护神兽图像本地缓存实现计划

## 问题分析

当前守护神兽海报生成功能存在以下问题：
1. 所有图片（背景图、小程序码、神兽图片）都存储在云开发环境中
2. 每次生成海报时都会调用 `wx.cloud.downloadFile` 重复下载相同图片
3. 没有本地缓存机制，导致网络请求频繁，影响海报生成速度
4. 异步下载过程可能影响用户体验

## 缓存方案设计

### 1. 缓存机制
- 使用微信小程序的 `wx.getFileSystemManager()` API 进行本地文件存储
- 结合 `wx.setStorageSync` 存储缓存索引，记录文件ID与本地路径的映射关系
- 实现缓存检查、下载、更新的完整流程

### 2. 缓存管理策略
- **缓存命名**：使用文件ID的哈希值作为本地缓存文件名，避免冲突
- **缓存有效期**：设置合理的缓存过期时间（如7天）
- **缓存清理**：定期清理过期缓存，避免占用过多存储空间

### 3. 核心功能实现
- `getImageFromCache`：检查本地缓存，返回缓存路径或null
- `saveImageToCache`：将下载的图片保存到本地缓存
- `downloadImage`：封装云文件下载逻辑，结合缓存机制
- `clearExpiredCache`：清理过期缓存

## 代码修改方案

### 1. 添加缓存工具函数
在 `poster.js` 文件中添加缓存管理相关的工具函数：
- 实现缓存检查、下载、保存的完整流程
- 统一处理云文件和本地文件的加载

### 2. 优化图片加载逻辑
- 修改 `generatePoster` 函数中的图片下载逻辑，引入缓存机制
- 修改 `loadBeastImage` 函数，使用缓存机制加载神兽图片
- 确保所有云文件下载都经过缓存处理

### 3. 添加缓存管理功能
- 添加缓存初始化逻辑，在页面加载时检查并清理过期缓存
- 添加缓存状态管理，记录缓存使用情况

## 实施步骤

1. **设计缓存工具函数**：
   - 实现 `getImageFromCache` 函数
   - 实现 `saveImageToCache` 函数
   - 实现 `downloadImage` 函数

2. **修改背景图和小程序码加载逻辑**：
   - 在 `generatePoster` 函数中引入缓存机制
   - 优化异步加载流程

3. **修改神兽图片加载逻辑**：
   - 在 `loadBeastImage` 函数中引入缓存机制
   - 确保所有云文件下载都经过缓存处理

4. **添加缓存管理功能**：
   - 实现缓存过期检查和清理
   - 添加缓存状态记录

5. **测试与优化**：
   - 测试缓存功能的正确性
   - 优化缓存策略和性能

## 预期效果

1. **减少网络请求**：同一图片只下载一次，后续直接从本地读取
2. **提高海报生成速度**：避免重复下载，加快海报生成流程
3. **优化用户体验**：减少等待时间，提高应用响应速度
4. **降低云存储流量消耗**：减少重复下载，降低云存储费用

## 技术要点

- 使用 `wx.getFileSystemManager()` 进行本地文件操作
- 结合 `wx.setStorageSync` 和 `wx.getStorageSync` 管理缓存索引
- 实现异步流程的合理管理，避免回调地狱
- 设计合理的缓存清理策略，避免占用过多存储空间