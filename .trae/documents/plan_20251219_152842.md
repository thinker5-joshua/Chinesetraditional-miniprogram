# 守护神兽海报箴言乱码问题优化计划

## 问题分析

根据代码检查，守护神兽海报生成时箴言出现乱码的可能原因如下：

1. **Canvas字体设置不当**：
   - 当前使用 `ctx.font = 'bold 17px serif'` 绘制箴言
   - `serif` 字体在不同设备上表现不一致，可能不支持中文
   - "恩泽遍及四海"这类中文短句需要明确支持中文的字体

2. **缺乏字体回退机制**：
   - 只指定了一种字体，没有提供备选方案
   - 当默认字体无法渲染中文时，没有其他字体可以 fallback

3. **文本绘制边界检查缺失**：
   - 没有检查文本长度和Canvas宽度，长文本可能被截断或显示异常
   - 未考虑不同字体下文本宽度的差异

4. **字体加载状态不确定**：
   - 没有确保字体完全加载就开始绘制
   - 中文特殊字体可能需要额外加载时间

## 优化方案

### 1. 优化字体设置
- 使用明确支持中文的字体组合，如 `sans-serif` 或系统默认字体
- 添加字体回退机制，确保跨设备兼容性
- 为中文文本指定更可靠的字体设置

### 2. 添加文本边界检查
- 使用 `measureText()` 方法检查文本宽度
- 对于超出Canvas宽度的文本，实现自动换行或调整字体大小
- 确保文本在Canvas范围内完整显示

### 3. 统一字体样式
- 对所有中文文本使用一致的字体设置
- 确保标题、正文等不同层级的文本都能正确显示中文

### 4. 增强错误处理
- 添加文本绘制失败的备选方案
- 确保即使字体加载失败，文本也能以默认样式显示

## 实施步骤

1. **修改Canvas字体设置**：
   - 将 `serif` 字体替换为支持中文的字体组合
   - 添加字体回退机制

2. **添加文本宽度检查**：
   - 在绘制前使用 `measureText()` 检查文本宽度
   - 实现长文本自动换行逻辑

3. **优化文本绘制逻辑**：
   - 确保文本居中显示
   - 调整行高和间距，提高可读性

4. **测试不同设备兼容性**：
   - 在不同型号的手机上测试中文显示效果
   - 确保"恩泽遍及四海"等中文短句能正确渲染

## 预期效果

- 解决守护箴言乱码问题
- 提高中文文本在不同设备上的显示一致性
- 增强文本绘制的鲁棒性
- 提升海报整体视觉效果和可读性