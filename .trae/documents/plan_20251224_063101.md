# 存卡片功能优化方案

## 问题分析
1. **图片加载失败导致流程卡住**：在 `saveHexagramCard` 函数中，小程序码图片使用了云存储路径，如果图片无法访问，`img.onload` 事件不会触发，导致整个保存流程卡住
2. **缺少图片加载失败处理**：没有添加 `img.onerror` 事件处理程序，无法处理图片加载失败的情况
3. **缺少防御性检查**：在绘制爻辞时，没有检查 `currentHexagram.yaoTexts` 是否存在或是否为数组
4. **加载提示可能一直显示**：如果某个步骤失败，没有及时隐藏加载提示

## 解决方案

### 1. 添加图片加载失败处理
- 在 `img` 对象上添加 `onerror` 事件处理程序
- 当图片加载失败时，跳过小程序码绘制，继续执行后续的保存流程
- 确保即使图片加载失败，也能给用户一个明确的反馈

### 2. 添加防御性检查
- 在绘制爻辞之前，检查 `currentHexagram.yaoTexts` 是否存在且是否为数组
- 如果 `yaoTexts` 不存在或不是数组，跳过爻辞绘制，或者显示默认内容

### 3. 优化错误处理
- 在各个关键步骤添加错误处理
- 确保无论哪个步骤失败，都能及时隐藏加载提示
- 给用户明确的错误信息反馈

### 4. 考虑使用本地图片
- 如果可能，考虑将小程序码图片替换为本地图片，避免网络请求失败的问题
- 或者确保云存储图片的路径是正确的，并且可以被访问到

## 预期效果
1. 存卡片功能不再会因为图片加载失败而卡住
2. 即使图片加载失败，也能完成卡片生成和保存
3. 各个步骤的错误都能被妥善处理，并给用户明确的反馈
4. 加载提示会在适当的时候隐藏，不会一直显示

## 修改文件
- `/subgames/64Hexagrams/index.js`

## 修改内容
1. 在 `saveHexagramCard` 函数中添加 `img.onerror` 事件处理程序
2. 在绘制爻辞之前添加防御性检查
3. 优化各个步骤的错误处理
4. 确保无论成功还是失败，都能及时隐藏加载提示

这个方案将彻底解决存卡片功能一直循环未结束的问题，提高功能的健壮性和用户体验。